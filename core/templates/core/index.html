{% extends "base.html" %}
{% block content %}

<h3>Pregunta a la IA</h3>
{% if messages %}
    {% for message in messages %}
    <div class="alert alert-danger">{{ message }}</div>
    {% endfor %}
{% endif %}
<form method="post" class="mb-4" id="question-form">
    {% csrf_token %}
    <div class="mb-3">
        {{ form.subject.label_tag }}
        {{ form.subject }}
    </div>
    <div class="mb-3">
        {{ form.topic.label_tag }}
        {{ form.topic }}
    </div>
    <div class="mb-3">
        {{ form.model.label_tag }}
        {{ form.model }}
    </div>
    <div class="mb-3 position-relative">
        {{ form.question.label_tag }}
        {{ form.question }}
        <button type="button" id="btn-mic" class="btn btn-outline-secondary position-absolute end-0 top-50 translate-middle-y me-3" style="height: 38px; width: 38px;" title="Hablar">
            <i class="bi bi-mic"></i>
        </button>
    </div>
    <div class="d-flex gap-2">
        <button type="submit" name="submit_question" class="btn btn-primary">Enviar Pregunta</button>
        <button type="submit" name="generate_exam" value="1" class="btn btn-outline-success ms-2">Realizar Examen</button>
    </div>
</form>

<h4>Mis últimas preguntas</h4>
<div class="list-group">
    {% for conv in conversations %}
    <div class="list-group-item list-group-item-action position-relative">
        <small class="text-muted">{{ conv.created_at|date:"d M Y H:i" }}</small><br>
        <strong>{{ conv.topic.subject }} → {{ conv.topic.name }}</strong><br>
        <em>{{ conv.question }}</em><br>
        <p>{{ conv.response }}</p>

        <!-- Botón eliminar -->
        <form action="{% url 'delete_conversation' conv.id %}" method="post" class="position-absolute top-0 end-0 m-2">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Estás seguro?')">Eliminar</button>
        </form>
    </div>
    {% empty %}
    <p>No tienes historial aún.</p>
    {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const subjectSelect = document.querySelector('#id_subject');
    const topicSelect = document.querySelector('#id_topic');

    function loadTopics(subjectId) {
        fetch('{% url "ajax_load_topics" %}?subject=' + subjectId)
            .then(response => response.json())
            .then(data => {
                topicSelect.innerHTML = '<option value="">---------</option>';
                data.topics.forEach(function (topic) {
                    const option = document.createElement('option');
                    option.value = topic.id;
                    option.text = topic.name;
                    topicSelect.appendChild(option);
                });
            });
    }

    subjectSelect.addEventListener('change', function () {
        const subjectId = this.value;
        if (subjectId) {
            loadTopics(subjectId);
        } else {
            topicSelect.innerHTML = '<option value="">---------</option>';
        }
    });

    // Cargar temas iniciales si hay asignatura seleccionada
    const selectedSubject = subjectSelect.value;
    if (selectedSubject) {
        loadTopics(selectedSubject);
    }
});
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SpeechRecognition) {
    const recognition = new SpeechRecognition();
    recognition.lang = 'es-ES';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    const micBtn = document.getElementById('btn-mic');
    const questionInput = document.querySelector('#id_question');

    micBtn.addEventListener('click', () => {
        recognition.start();
        micBtn.classList.add('btn-outline-danger');
        micBtn.innerHTML = '<i class="bi bi-mic-fill text-danger"></i>';
    });

    recognition.addEventListener('result', e => {
        const transcript = e.results[0][0].transcript;
        questionInput.value += transcript + ' ';
        recognition.stop();
        micBtn.classList.remove('btn-outline-danger');
        micBtn.innerHTML = '<i class="bi bi-mic"></i>';
    });

    recognition.addEventListener('end', () => {
        micBtn.classList.remove('btn-outline-danger');
        micBtn.innerHTML = '<i class="bi bi-mic"></i>';
    });
} else {
    console.warn("Tu navegador no soporta reconocimiento de voz.");
}
</script>
{% endblock %}