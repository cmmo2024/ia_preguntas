<!-- templates/core/profile.html -->
{% extends "base.html" %}
{% load math_filters date_filters %} <!-- Importante -->
{% load static %}
{% block content %}
<div class="animate-fade-in">
<div class="d-flex justify-content-between align-items-center">
    <h2>Perfil de {{ user.username }}</h2>
    <a href="{% url 'edit_profile' %}" class="btn btn-sm btn-outline-primary">Editar perfil</a>
</div>
<!-- Aquí mostramos los mensajes -->
{% if messages %}
<div class="container mt-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags|default:"info" }} d-flex align-items-center justify-content-between fade show animate__animated animate__fadeInDown"
         role="alert" style="margin-bottom: 1rem;">
        <div class="d-flex align-items-center">
            {% if message.tags == "success" %}
            <i class="bi bi-check-circle-fill text-success me-2" style="font-size: 1.2rem;"></i>
            {% elif message.tags == "error" or message.tags == "danger" %}
            <i class="bi bi-exclamation-octagon-fill text-danger me-2" style="font-size: 1.2rem;"></i>
            {% elif message.tags == "warning" %}
            <i class="bi bi-exclamation-triangle-fill text-warning me-2" style="font-size: 1.2rem;"></i>
            {% else %}
            <i class="bi bi-info-circle-fill text-primary me-2" style="font-size: 1.2rem;"></i>
            {% endif %}
        <span>{{ message }}</span>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="row">
    <div class="col-md-8">
        <ul class="list-group mb-4">
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><strong>Nombre de Usuario:</strong></span>
                <span>{{ user.username }}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><strong>Nombre completo:</strong></span>
                <span>{{ user.first_name|default:"No definido" }}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><strong>Email:</strong></span>
                <span>{{ user.email }}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><strong>Plan:</strong></span>
                <span class="badge bg-primary">{{ profile.get_plan_display }}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><strong>Categoría profesional:</strong></span>
                <span>{{ user.userprofile.get_category_display|default:"No definida" }}</span>
            </li>
            {% with config=profile.plan_config %}
                <li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <span><strong>Peticiones a la IA:</strong></span>
                        <span>
                            {% if profile.plan == 'free' %}
                                {% if profile.daily_requests >= config.daily_requests %}
                                    <span class="text-danger">⚠️ Límite alcanzado</span>
                                {% else %}
                                    {{ profile.daily_requests }} / {{ config.daily_requests }}
                                {% endif %}
                            {% else %}
                                {{ profile.total_requests }} / {{ config.total_requests }}
                            {% endif %}
                        </span>
                    </div>

                    {% if profile.plan == 'free' and profile.daily_requests < config.daily_requests %}
                        <!-- Barra de progreso para plan free -->
                        <div class="progress mt-1" style="height: 20px;">
                            <div class="progress-bar" role="progressbar"
                                style="width: {{ profile.daily_requests|div:config.daily_requests|mul:100 }}%;">
                                {{ profile.daily_requests|div:config.daily_requests|mul:100|floatformat:"0" }}%
                            </div>
                        </div>
                    {% elif profile.plan == 'free' and profile.daily_requests >= config.daily_requests %}
                        <div class="alert alert-warning mt-2 mb-0 small" role="alert">
                            Has alcanzado el límite de 3 peticiones diarias.  
                            <strong>Se reiniciará en 24 horas</strong> desde tu última pregunta.  
                        </div>
                    {% else %}
                        <!-- Barra de progreso para plan premium -->
                        <div class="progress mt-1" style="height: 20px;">
                            <div class="progress-bar" role="progressbar"
                                style="width: {{ profile.total_requests|div:config.total_requests|mul:100 }}%;">
                                {{ profile.total_requests|div:config.total_requests|mul:100|floatformat:"0" }}%
                            </div>
                        </div>
                    {% endif %}
                </li>
            {% endwith %}

        </ul>

        <!-- Botón Upgrade -->
        {% if profile.plan != 'premium' %}
        <h3>Upgrade a Premium</h3>
        <!-- Botón de pago 
        <form action="{% url 'create_payment' %}" method="POST">
            {% csrf_token %}
           <button type="submit" class="btn btn-success mt-3" style="background-color: blue; color: white;">Pago por Stripe</button>
        </form>
        -->
       <div style="display: flex; align-items: center; gap: 10px;">
            <a href="https://tppay.me/md0u2ofs " class="btn btn-success mt-3" style="background-color: blue; color: white; padding: 10px 20px; font-size: 16px; display: flex; align-items: center; margin: 0;">
                Pago por TropiPay
            </a>
            <img src="{% static 'images/VisaCard.png' %}" alt="Visa" style="height: 45px; width: auto; vertical-align: middle; display: block;">
        </div>
        <a href="{% url 'transfermovil' %}" class="btn btn-success mt-3">Pago por Transfermovil</a>
        {% endif %}
    </div>
</div>
<p> </p>
<!-- Notificación de bajo rendimiento -->
{% if weak_areas %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <h6><i class="bi bi-exclamation-triangle-fill"></i> Recomendación semanal</h6>
        <p class="mb-1">Te sugerimos repasar los siguientes temas para mejorar tu rendimiento:</p>
        <ul class="mb-0">
            {% for area in weak_areas %}
                <li><strong>{{ area.name }}</strong> — {{ area.score }}% de aciertos</li>
            {% endfor %}
        </ul>
        <small class="text-muted">Basado en tus exámenes de las últimas 2 semanas.</small>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
{% endif %}

<li class="list-group-item">
    <h3>Estadísticas de Exámenes:</h3>
    <ul class="mt-3">
        <li>Promedio: {{ average_score }}%</li>
        <li>Exámenes realizados: {{ total_exams }}</li>
        <li>Total de preguntas: {{ total_questions }}</li>
        <li>Aciertos: {{ correct_answers }}</li>
    </ul>
</li>
<div class="text-center mt-4">
    <a href="{% url 'performance_stats' %}" 
       class="btn btn-primary btn-lg px-4 py-3 shadow">
        <i class="bi bi-bar-chart-line me-2"></i>
        Ver Estadísticas de Rendimiento
    </a>
    <div class="text-muted mt-2 small">
        Descubre cómo estás progresando
    </div>
</div>
<p> </p>
<li class="list-group-item">
    <!-- Título y filtros -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h3 class="mb-0">Historial de exámenes</h3>
    </div>

    <!-- Filtros -->
    <div class="card mb-3 p-3 bg-light border rounded small">
        <form id="exam-filter-form" class="row g-3">
            <!-- Filtro por asignatura -->
            <div class="col-md-5 col-12">
                <label for="filter-subject" class="form-label small mb-1">Asignatura</label>
                <select id="filter-subject" class="form-select form-select-sm">
                    <option value="">Todas las asignaturas</option>
                    {% for subject in subjects %}
                        <option value="{{ subject.name }}">{{ subject.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Filtro por tema -->
            <div class="col-md-5 col-12">
                <label for="filter-topic" class="form-label small mb-1">Tema</label>
                <select id="filter-topic" class="form-select form-select-sm">
                    <option value="">Todos los temas</option>
                </select>
            </div>

            <!-- Botón limpiar -->
            <div class="col-md-2 col-12 d-flex align-items-end">
                <button type="button" id="clear-filters" class="btn btn-outline-secondary btn-sm w-100">Limpiar</button>
            </div>
        </form>
    </div>

    <!-- Lista de exámenes -->
    <ul id="exam-list" class="mt-3 list-unstyled">
        {% include "core/_exams_list.html" %}
    </ul>
    <!-- Contenedor de paginación -->
    <div id="pagination-container"></div>
</li>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const subjectSelect = document.getElementById('filter-subject');
    const topicSelect = document.getElementById('filter-topic');
    const examList = document.getElementById('exam-list');
    const paginationContainer = document.getElementById('pagination-container'); // Añade este contenedor

    // Función para aplicar filtros y paginar
    function filterExams(page = 1) {
        const subject = subjectSelect.value;
        const topic = topicSelect.value;

        $.get("{% url 'filter_exams' %}", {
            subject: subject,
            topic: topic,
            page: page
        }, function(data) {
            examList.innerHTML = data.html;
            paginationContainer.innerHTML = data.pagination_html;
        }).fail(function() {
            examList.innerHTML = '<li class="text-danger">Error al cargar exámenes.</li>';
        });
    }

    // Cargar temas al cambiar asignatura
    subjectSelect.addEventListener('change', function () {
        const subjectName = this.value;
        topicSelect.innerHTML = '<option value="">Todos los temas</option>';

        if (!subjectName) {
            filterExams();
            return;
        }

        $.get("{% url 'ajax_load_topics' %}", { subject_name: subjectName }, function(data) {
            data.topics.forEach(function(topic) {
                const option = document.createElement('option');
                option.value = topic.name;
                option.textContent = topic.name;
                topicSelect.appendChild(option);
            });
            filterExams(); // Vuelve a filtrar exámenes
        }).fail(function() {
            console.error("Error cargando temas");
            filterExams();
        });
    });

    // Cambiar tema
    topicSelect.addEventListener('change', function () {
        filterExams();
    });

    // Limpiar filtros
    document.getElementById('clear-filters').addEventListener('click', function () {
        subjectSelect.value = '';
        topicSelect.innerHTML = '<option value="">Todos los temas</option>';
        filterExams();
    });

    // Delegación de eventos para paginación
    document.addEventListener('click', function(e) {
        const target = e.target.closest('[data-page]');
        if (target && paginationContainer.contains(target)) {
            e.preventDefault();
            const page = target.getAttribute('data-page');
            filterExams(page);
        }
    });

    // Inicializar con primera página
    filterExams();
});
</script>
</div>
{% endblock %}